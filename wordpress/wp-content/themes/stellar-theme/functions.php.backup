<?php
/**
 * Stellar Theme Functions
 * 
 * @package Stellar
 * @since 1.0.0
 */

// Prevent direct access
if (!defined('ABSPATH')) {
    exit;
}

// Define theme constants
define('STELLAR_THEME_VERSION', '1.0.0');
define('STELLAR_THEME_PATH', get_template_directory());
define('STELLAR_THEME_URL', get_template_directory_uri());

/**
 * Theme setup
 */
function stellar_setup() {
    // Add theme support for various features
    add_theme_support('title-tag');
    add_theme_support('post-thumbnails');
    add_theme_support('html5', array(
        'search-form',
        'comment-form',
        'comment-list',
        'gallery',
        'caption',
        'style',
        'script'
    ));
    add_theme_support('custom-logo');
    add_theme_support('customize-selective-refresh-widgets');
    add_theme_support('responsive-embeds');
    add_theme_support('wp-block-styles');
    add_theme_support('align-wide');
    
    // Add support for WooCommerce
    add_theme_support('woocommerce');
    add_theme_support('wc-product-gallery-zoom');
    add_theme_support('wc-product-gallery-lightbox');
    add_theme_support('wc-product-gallery-slider');
    
    // Register navigation menus
    register_nav_menus(array(
        'primary' => __('Primary Menu', 'stellar'),
        'footer' => __('Footer Menu', 'stellar'),
        'mobile' => __('Mobile Menu', 'stellar')
    ));
    
    // Set content width
    if (!isset($content_width)) {
        $content_width = 1200;
    }
}
add_action('after_setup_theme', 'stellar_setup');

/**
 * Enqueue scripts and styles
 */
function stellar_scripts() {
    // Enqueue main stylesheet
    wp_enqueue_style('stellar-style', STELLAR_THEME_URL . '/assets/css/style.css', array(), STELLAR_THEME_VERSION);
    
    // Enqueue vendor CSS
    wp_enqueue_style('stellar-aos', STELLAR_THEME_URL . '/assets/css/vendors/aos.css', array(), STELLAR_THEME_VERSION);
    wp_enqueue_style('stellar-swiper', STELLAR_THEME_URL . '/assets/css/vendors/swiper-bundle.min.css', array(), STELLAR_THEME_VERSION);
    
    // Enqueue additional styles
    wp_enqueue_style('stellar-theme', STELLAR_THEME_URL . '/assets/css/additional-styles/theme.css', array(), STELLAR_THEME_VERSION);
    wp_enqueue_style('stellar-utility', STELLAR_THEME_URL . '/assets/css/additional-styles/utility-patterns.css', array(), STELLAR_THEME_VERSION);
    
    // Enqueue JavaScript
    wp_enqueue_script('stellar-alpine', STELLAR_THEME_URL . '/assets/js/vendors/alpinejs.min.js', array(), STELLAR_THEME_VERSION, true);
    wp_enqueue_script('stellar-aos', STELLAR_THEME_URL . '/assets/js/vendors/aos.js', array(), STELLAR_THEME_VERSION, true);
    wp_enqueue_script('stellar-swiper', STELLAR_THEME_URL . '/assets/js/vendors/swiper-bundle.min.js', array(), STELLAR_THEME_VERSION, true);
    wp_enqueue_script('stellar-main', STELLAR_THEME_URL . '/assets/js/main.js', array('jquery'), STELLAR_THEME_VERSION, true);
    
    // Localize script for AJAX
    wp_localize_script('stellar-main', 'stellar_ajax', array(
        'ajax_url' => admin_url('admin-ajax.php'),
        'nonce' => wp_create_nonce('stellar_nonce')
    ));
    
    // Comment reply script
    if (is_singular() && comments_open() && get_option('thread_comments')) {
        wp_enqueue_script('comment-reply');
    }
}
add_action('wp_enqueue_scripts', 'stellar_scripts');

/**
 * Register widget areas
 */
function stellar_widgets_init() {
    register_sidebar(array(
        'name' => __('Sidebar', 'stellar'),
        'id' => 'sidebar-1',
        'description' => __('Add widgets here.', 'stellar'),
        'before_widget' => '<section id="%1$s" class="widget %2$s">',
        'after_widget' => '</section>',
        'before_title' => '<h3 class="widget-title">',
        'after_title' => '</h3>',
    ));
    
    register_sidebar(array(
        'name' => __('Footer Widget Area', 'stellar'),
        'id' => 'footer-1',
        'description' => __('Add footer widgets here.', 'stellar'),
        'before_widget' => '<div id="%1$s" class="widget %2$s">',
        'after_widget' => '</div>',
        'before_title' => '<h6 class="widget-title">',
        'after_title' => '</h6>',
    ));
}
add_action('widgets_init', 'stellar_widgets_init');

/**
 * Custom post types
 */
function stellar_custom_post_types() {
    // Team Members
    register_post_type('team_member', array(
        'labels' => array(
            'name' => __('Team Members', 'stellar'),
            'singular_name' => __('Team Member', 'stellar'),
            'add_new' => __('Add New', 'stellar'),
            'add_new_item' => __('Add New Team Member', 'stellar'),
            'edit_item' => __('Edit Team Member', 'stellar'),
            'new_item' => __('New Team Member', 'stellar'),
            'view_item' => __('View Team Member', 'stellar'),
            'search_items' => __('Search Team Members', 'stellar'),
            'not_found' => __('No team members found', 'stellar'),
            'not_found_in_trash' => __('No team members found in trash', 'stellar'),
        ),
        'public' => true,
        'has_archive' => true,
        'menu_icon' => 'dashicons-groups',
        'supports' => array('title', 'editor', 'thumbnail', 'excerpt'),
        'show_in_rest' => true,
    ));
    
    // Testimonials
    register_post_type('testimonial', array(
        'labels' => array(
            'name' => __('Testimonials', 'stellar'),
            'singular_name' => __('Testimonial', 'stellar'),
            'add_new' => __('Add New', 'stellar'),
            'add_new_item' => __('Add New Testimonial', 'stellar'),
            'edit_item' => __('Edit Testimonial', 'stellar'),
            'new_item' => __('New Testimonial', 'stellar'),
            'view_item' => __('View Testimonial', 'stellar'),
            'search_items' => __('Search Testimonials', 'stellar'),
            'not_found' => __('No testimonials found', 'stellar'),
            'not_found_in_trash' => __('No testimonials found in trash', 'stellar'),
        ),
        'public' => true,
        'has_archive' => true,
        'menu_icon' => 'dashicons-format-quote',
        'supports' => array('title', 'editor', 'thumbnail'),
        'show_in_rest' => true,
    ));
    
    // Features/Integrations
    register_post_type('feature', array(
        'labels' => array(
            'name' => __('Features', 'stellar'),
            'singular_name' => __('Feature', 'stellar'),
            'add_new' => __('Add New', 'stellar'),
            'add_new_item' => __('Add New Feature', 'stellar'),
            'edit_item' => __('Edit Feature', 'stellar'),
            'new_item' => __('New Feature', 'stellar'),
            'view_item' => __('View Feature', 'stellar'),
            'search_items' => __('Search Features', 'stellar'),
            'not_found' => __('No features found', 'stellar'),
            'not_found_in_trash' => __('No features found in trash', 'stellar'),
        ),
        'public' => true,
        'has_archive' => true,
        'menu_icon' => 'dashicons-star-filled',
        'supports' => array('title', 'editor', 'thumbnail', 'excerpt'),
        'show_in_rest' => true,
    ));
}
add_action('init', 'stellar_custom_post_types');

/**
 * Custom meta boxes
 */
function stellar_add_meta_boxes() {
    add_meta_box(
        'team_member_details',
        __('Team Member Details', 'stellar'),
        'stellar_team_member_meta_box',
        'team_member',
        'normal',
        'high'
    );
    
    add_meta_box(
        'testimonial_details',
        __('Testimonial Details', 'stellar'),
        'stellar_testimonial_meta_box',
        'testimonial',
        'normal',
        'high'
    );
}
add_action('add_meta_boxes', 'stellar_add_meta_boxes');

/**
 * Team member meta box
 */
function stellar_team_member_meta_box($post) {
    wp_nonce_field('stellar_team_member_meta_box', 'stellar_team_member_meta_box_nonce');
    
    $position = get_post_meta($post->ID, '_team_member_position', true);
    $social_twitter = get_post_meta($post->ID, '_team_member_social_twitter', true);
    $social_linkedin = get_post_meta($post->ID, '_team_member_social_linkedin', true);
    
    echo '<table class="form-table">';
    echo '<tr><th><label for="team_member_position">' . __('Position', 'stellar') . '</label></th>';
    echo '<td><input type="text" id="team_member_position" name="team_member_position" value="' . esc_attr($position) . '" size="50" /></td></tr>';
    echo '<tr><th><label for="team_member_social_twitter">' . __('Twitter URL', 'stellar') . '</label></th>';
    echo '<td><input type="url" id="team_member_social_twitter" name="team_member_social_twitter" value="' . esc_attr($social_twitter) . '" size="50" /></td></tr>';
    echo '<tr><th><label for="team_member_social_linkedin">' . __('LinkedIn URL', 'stellar') . '</label></th>';
    echo '<td><input type="url" id="team_member_social_linkedin" name="team_member_social_linkedin" value="' . esc_attr($social_linkedin) . '" size="50" /></td></tr>';
    echo '</table>';
}

/**
 * Testimonial meta box
 */
function stellar_testimonial_meta_box($post) {
    wp_nonce_field('stellar_testimonial_meta_box', 'stellar_testimonial_meta_box_nonce');
    
    $author = get_post_meta($post->ID, '_testimonial_author', true);
    $position = get_post_meta($post->ID, '_testimonial_author_position', true);
    $company = get_post_meta($post->ID, '_testimonial_company', true);
    
    echo '<table class="form-table">';
    echo '<tr><th><label for="testimonial_author">' . __('Author Name', 'stellar') . '</label></th>';
    echo '<td><input type="text" id="testimonial_author" name="testimonial_author" value="' . esc_attr($author) . '" size="50" /></td></tr>';
    echo '<tr><th><label for="testimonial_author_position">' . __('Author Position', 'stellar') . '</label></th>';
    echo '<td><input type="text" id="testimonial_author_position" name="testimonial_author_position" value="' . esc_attr($position) . '" size="50" /></td></tr>';
    echo '<tr><th><label for="testimonial_company">' . __('Company', 'stellar') . '</label></th>';
    echo '<td><input type="text" id="testimonial_company" name="testimonial_company" value="' . esc_attr($company) . '" size="50" /></td></tr>';
    echo '</table>';
}

/**
 * Save meta box data
 */
function stellar_save_meta_boxes($post_id) {
    // Team member meta
    if (isset($_POST['stellar_team_member_meta_box_nonce']) && wp_verify_nonce($_POST['stellar_team_member_meta_box_nonce'], 'stellar_team_member_meta_box')) {
        if (isset($_POST['team_member_position'])) {
            update_post_meta($post_id, '_team_member_position', sanitize_text_field($_POST['team_member_position']));
        }
        if (isset($_POST['team_member_social_twitter'])) {
            update_post_meta($post_id, '_team_member_social_twitter', esc_url_raw($_POST['team_member_social_twitter']));
        }
        if (isset($_POST['team_member_social_linkedin'])) {
            update_post_meta($post_id, '_team_member_social_linkedin', esc_url_raw($_POST['team_member_social_linkedin']));
        }
    }
    
    // Testimonial meta
    if (isset($_POST['stellar_testimonial_meta_box_nonce']) && wp_verify_nonce($_POST['stellar_testimonial_meta_box_nonce'], 'stellar_testimonial_meta_box')) {
        if (isset($_POST['testimonial_author'])) {
            update_post_meta($post_id, '_testimonial_author', sanitize_text_field($_POST['testimonial_author']));
        }
        if (isset($_POST['testimonial_author_position'])) {
            update_post_meta($post_id, '_testimonial_author_position', sanitize_text_field($_POST['testimonial_author_position']));
        }
        if (isset($_POST['testimonial_company'])) {
            update_post_meta($post_id, '_testimonial_company', sanitize_text_field($_POST['testimonial_company']));
        }
    }
}
add_action('save_post', 'stellar_save_meta_boxes');

/**
 * Theme customizer
 */
function stellar_customize_register($wp_customize) {
    // Hero Section
    $wp_customize->add_section('stellar_hero', array(
        'title' => __('Hero Section', 'stellar'),
        'priority' => 30,
    ));
    
    $wp_customize->add_setting('hero_title', array(
        'default' => 'The API Security Framework',
        'sanitize_callback' => 'sanitize_text_field',
    ));
    
    $wp_customize->add_control('hero_title', array(
        'label' => __('Hero Title', 'stellar'),
        'section' => 'stellar_hero',
        'type' => 'text',
    ));
    
    $wp_customize->add_setting('hero_subtitle', array(
        'default' => 'Our landing page template works on all devices, so you only have to set it up once, and get beautiful results forever.',
        'sanitize_callback' => 'sanitize_textarea_field',
    ));
    
    $wp_customize->add_control('hero_subtitle', array(
        'label' => __('Hero Subtitle', 'stellar'),
        'section' => 'stellar_hero',
        'type' => 'textarea',
    ));
    
    // Footer
    $wp_customize->add_section('stellar_footer', array(
        'title' => __('Footer', 'stellar'),
        'priority' => 40,
    ));
    
    $wp_customize->add_setting('footer_copyright', array(
        'default' => '© Cruip.com - All rights reserved.',
        'sanitize_callback' => 'sanitize_text_field',
    ));
    
    $wp_customize->add_control('footer_copyright', array(
        'label' => __('Copyright Text', 'stellar'),
        'section' => 'stellar_footer',
        'type' => 'text',
    ));
}
add_action('customize_register', 'stellar_customize_register');

/**
 * Security enhancements
 */
function stellar_security_headers() {
    if (!is_admin()) {
        header('X-Content-Type-Options: nosniff');
        header('X-Frame-Options: SAMEORIGIN');
        header('X-XSS-Protection: 1; mode=block');
    }
}
add_action('send_headers', 'stellar_security_headers');

/**
 * Remove WordPress version from head
 */
remove_action('wp_head', 'wp_generator');

/**
 * Disable XML-RPC
 */
add_filter('xmlrpc_enabled', '__return_false');

/**
 * Remove unnecessary WordPress features
 */
remove_action('wp_head', 'rsd_link');
remove_action('wp_head', 'wlwmanifest_link');
remove_action('wp_head', 'wp_shortlink_wp_head');

/**
 * Custom excerpt length
 */
function stellar_excerpt_length($length) {
    return 25;
}
add_filter('excerpt_length', 'stellar_excerpt_length');

/**
 * Custom excerpt more
 */
function stellar_excerpt_more($more) {
    return '...';
}
add_filter('excerpt_more', 'stellar_excerpt_more');

/**
 * Add custom body classes
 */
function stellar_body_classes($classes) {
    if (is_front_page()) {
        $classes[] = 'home-page';
    }
    
    if (is_page_template('page-about.php')) {
        $classes[] = 'about-page';
    }
    
    return $classes;
}
add_filter('body_class', 'stellar_body_classes');

/**
 * Include additional theme files
 */
require_once STELLAR_THEME_PATH . '/inc/customizer.php';
require_once STELLAR_THEME_PATH . '/inc/helpers.php';
require_once STELLAR_THEME_PATH . '/inc/seo.php';
require_once STELLAR_THEME_PATH . '/inc/woocommerce.php';
